<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Roast | Ekstraksiyon G√ºnl√ºƒü√º</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root { --bg-color: #F4F4F6; --card-bg: #FFFFFF; --primary: #8B9A8B; --border-color: #E2E4E9; --text-main: #2C303A; --text-light: #8E94A3; --reference-bg: #F9FAFB; --modal-bg: rgba(44,48,58,0.5); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
        
        /* Sayfanƒ±n sonsuza uzamasƒ±nƒ± engelliyoruz. Tam ekran oturacak. */
        body { background-color: var(--bg-color); color: var(--text-main); padding: 1rem 2rem; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        iframe { border: none !important; outline: none !important; box-shadow: none !important; }

        .auth-bar { width: 100%; max-width: 1300px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.5px; }
        .user-info { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; color: var(--text-main); transition: 0.2s; font-size: 0.85rem;}

        /* 3'L√ú GRID YAPISI VE KARTLARIN Dƒ∞NAMƒ∞K BOYU */
        .container { max-width: 1300px; width: 100%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; align-items: stretch; flex-grow: 1; min-height: 0; }
        
        /* Kartlarƒ±n i√ßi ta≈üarsa kendi i√ßinde kaydƒ±rƒ±r, sayfayƒ± uzatmaz */
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; }
        .card::-webkit-scrollbar { width: 4px; }
        .card::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

        h2 { font-size: 1.05rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        
        /* Form elemanlarƒ± biraz daha sƒ±kƒ±la≈ütƒ±rƒ±ldƒ± */
        .form-group { margin-bottom: 0.8rem; position: relative; }
        label { display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.3rem; font-weight: 500;}
        input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: #FAFAFB; transition: 0.2s; font-size: 0.85rem;}
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; }

        .filter-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .tab-btn { flex: 1; padding: 0.4rem; font-size: 0.75rem; border: 1px solid var(--border-color); background: white; border-radius: 4px; cursor: pointer; color: var(--text-light); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 150px; overflow-y: auto; display: none; }
        .search-item { padding: 0.6rem; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid #f5f5f5; }
        .search-item:hover { background-color: var(--reference-bg); }

        #logsContainer { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .log-date-header { font-size: 0.7rem; font-weight: 700; color: var(--text-light); margin: 1rem 0 0.4rem 0; text-transform: uppercase; }
        .log-item { background: #FFFFFF; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 0.6rem; font-size: 0.85rem; }
        
        .vibe-tag { font-size: 0.7rem; color: var(--primary); background: var(--reference-bg); padding: 3px 6px; border-radius: 4px; display: inline-block; margin-top: 6px; margin-right: 4px; border: 1px solid #e0e5e0; }
        .has-brew-date { background: var(--primary) !important; color: white !important; border-radius: 50%; border: none !important; }

        .btn-primary { width: 100%; padding: 0.8rem; background-color: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        
        .ref-card { background-color: var(--reference-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; display: none; margin-bottom: 1rem;}
        .ref-card.active { display: block; }
        .ref-badge { display: inline-block; background-color: var(--primary); color: white; font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-bottom: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .ref-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.8rem; text-align: center; }
        .ref-stat-val { font-size: 1rem; font-weight: 600; display: block; color: var(--text-main);}
        .ref-stat-label { font-size: 0.7rem; color: var(--text-light); }
        .ref-note { font-size: 0.8rem; font-style: italic; color: var(--text-light); border-left: 3px solid var(--primary); padding-left: 0.8rem; }

        /* FOOTER (YENƒ∞) */
        .footer { width: 100%; max-width: 1300px; display: flex; justify-content: center; align-items: center; gap: 0.8rem; margin-top: 1rem; padding-top: 0.5rem; color: var(--text-light); font-size: 0.75rem; font-weight: 500; border-top: 1px solid var(--border-color); }
        .footer a { color: var(--text-light); display: flex; align-items: center; text-decoration: none; transition: 0.2s; }
        .footer a:hover { color: var(--primary); }
        .footer svg { width: 14px; height: 14px; margin-right: 4px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; backdrop-filter: blur(3px); transition: 0.3s; z-index: 1000;}
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 320px; }

        /* Mobil G√∂r√ºn√ºm (Ekrana sƒ±ƒüma iptal, kaydƒ±rma serbest) */
        @media (max-width: 1024px) { 
            body { height: auto; overflow: auto; padding: 1rem; } 
            .container { grid-template-columns: 1fr; } 
            .card { height: auto; overflow: visible; } 
        }
    </style>
</head>
<body>

    <div class="auth-bar">
        <div class="logo">Post Roast</div>
        <div class="user-info">
            <span id="userEmail" style="display: none; color: var(--text-light);"></span>
            <button class="btn-outline" id="loginBtnTrigger">Giri≈ü Yap</button>
            <button class="btn-outline" id="logoutBtn" style="display: none;">√áƒ±kƒ±≈ü Yap</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Rit√ºel</h2>
            
            <div class="form-group">
                <label>√áekirdek Ara & Se√ß</label>
                <input type="text" id="beanSearch" placeholder="Kavurucu veya √ßekirdek adƒ±..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
                <select id="finalBeanSelect" style="display: none;"></select>
            </div>

            <div class="ref-card" id="refCard">
                <span class="ref-badge">Referans</span>
                <div class="ref-stats">
                    <div><span class="ref-stat-val" id="refTemp">-</span><span class="ref-stat-label">Isƒ±</span></div>
                    <div><span class="ref-stat-val" id="refGrind">-</span><span class="ref-stat-label">Klik</span></div>
                    <div><span class="ref-stat-val" id="refRatio">-</span><span class="ref-stat-label">Oran</span></div>
                </div>
                <p class="ref-note" id="refNote">√ñrn: Yasemin, bergamot...</p>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Ekipman</label>
                    <select id="brewerSelect">
                        <option value="">Se√ßiniz...</option>
                        <option value="V60">V60</option>
                        <option value="V27">V27</option>
                        <option value="AeroPress">AeroPress</option>
                        <option value="French Press">French Press</option>
                        <option value="Origami">Origami</option>
                        <option value="Hario Switch">Hario Switch</option>
                        <option value="Crystal Eye">Crystal Eye</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filtre Kaƒüƒ±dƒ±</label>
                    <select id="filterSelect">
                        <option value="">Se√ßiniz...</option>
                        <option value="Abaca Plus">Abaca Plus</option>
                        <option value="Hario Japan">Hario Japan</option>
                        <option value="TH-1">TH-1</option>
                        <option value="TH-2">TH-2</option>
                        <option value="TH-3">TH-3</option>
                        <option value="Yok / Metal">Yok / Metal</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Deƒüirmen</label>
                <select id="grinderSelect"><option value="">Deƒüirmenler y√ºkleniyor...</option></select>
            </div>

            <div class="grid-2">
                <div class="form-group"><label>Sƒ±caklƒ±k (¬∞C)</label><input type="number" id="tempInput" placeholder="92"></div>
                <div class="form-group"><label>Klik</label><input type="number" id="clickInput" placeholder="24"></div>
            </div>

            <div class="form-group">
                <label>Kullanƒ±lan Su</label>
                <input type="text" id="waterInput" placeholder="√ñrn: Buzdaƒüƒ±, Arƒ±tma...">
            </div>
            
            <div class="grid-3">
                <div class="form-group"><label>Kalsiyum</label><input type="number" step="0.1" id="waterCa" placeholder="Ca"></div>
                <div class="form-group"><label>Sodyum</label><input type="number" step="0.1" id="waterNa" placeholder="Na"></div>
                <div class="form-group"><label>Potasyum</label><input type="number" step="0.1" id="waterK" placeholder="K"></div>
            </div>
        </div>

        <div class="card">
            <h2>Atmosfer & Deneyim</h2>
            
            <div class="form-group">
                <label>Ruh Hali</label>
                <input type="text" id="moodInput" placeholder="√ñrn: Yaƒümurlu bir sabah, dingin...">
            </div>

            <div class="form-group">
                <label>Dinlediƒüiniz M√ºzik</label>
                <input type="text" id="musicInput" placeholder="√ñrn: Miles Davis - Blue in Green">
            </div>

            <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                <label>Tadƒ±m Notlarƒ±</label>
                <textarea id="notesInput" style="flex-grow: 1; resize: none;" placeholder="Unutmayƒ±n; iyi bir kahve sadece √ßekirdekle deƒüil, o anki ruh halimiz ve arka planda √ßalan m√ºzikle de demlenir. Bardaktaki notalar neler?"></textarea>
            </div>
            
            <div style="margin-top: 1rem;">
                <p id="targetDateDisplay" style="font-size: 0.75rem; color: var(--primary); margin-bottom: 8px; font-weight: 600; text-align: center;">Se√ßili G√ºn: Bug√ºn</p>
                <button class="btn-primary" id="saveBtn">G√ºnl√ºƒüe Kaydet</button>
                <p id="statusMsg" style="text-align: center; font-size: 0.8rem; margin-top: 8px; font-weight: 600;"></p>
            </div>
        </div>

        <div class="card">
            <h2>Rit√ºel Ar≈üivi</h2>
            
            <div class="filter-tabs">
                <button class="tab-btn" data-type="all">T√ºm√º</button>
                <button class="tab-btn active" data-type="filtre">Filtre</button>
                <button class="tab-btn" data-type="espresso">Espresso</button>
            </div>

            <div class="form-group">
                <label>Takvim (Tƒ±kla ve Kayƒ±t Tarihini Se√ß)</label>
                <input type="text" id="masterCalendar" placeholder="Tarih se√ßmek i√ßin tƒ±kla...">
            </div>

            <div id="logsContainer"></div>
        </div>
    </div>

    <div class="footer">
        <span>&copy; 2026 Post Roast.</span>
        <a href="https://instagram.com/postroastco" target="_blank" title="Instagram">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
            @postroast
        </a>
    </div>

    <div class="modal" id="authModal">
        <div class="modal-content">
            <h3 style="text-align: center; margin-bottom: 1rem;">Post Roast Giri≈ü</h3>
            <div id="magicLinkForm">
                <input type="email" id="authEmail" placeholder="kahvetutkunu@mail.com" style="margin-bottom: 1rem; text-align: center;">
                <div class="cf-turnstile" data-sitekey="0x4AAAAAACfmb3Fmt8T7v11x" style="margin-bottom: 1rem; display: flex; justify-content: center;"></div>
                <button class="btn-primary" id="magicLinkBtn">Baƒülantƒ± G√∂nder</button>
            </div>
            <div id="magicLinkSuccess" style="display: none; text-align: center; color: #2e7d32; background: #e8f5e9; padding: 1rem; border-radius: 6px; font-size: 0.8rem;">
                <b>Giri≈ü Linkini G√∂nderdik!</b><br>E-postanƒ±zƒ± kontrol eder misiniz?
            </div>
            <p id="authErrorMsg" style="color: #d9534f; font-size: 0.8rem; margin-top: 1rem; text-align: center;"></p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fczapxjfbpddkburssez.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjemFweGpmYnBkZGtidXJzc2V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDQ4MTYsImV4cCI6MjA4NzA4MDgxNn0.7eyw43dNE7DRnOvRIQFanQXvUCX7bPpYh5qlrAUMMk0';
        const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentBeans = [], brewLogs = [], currentUser = null;
        let selectedDate = new Date().toLocaleDateString('en-CA');
        document.getElementById('targetDateDisplay').innerText = `Se√ßili G√ºn: ${selectedDate}`;
        
        let activeTypeFilter = 'filtre'; 
        let fpInstance = null;

        function initCalendar(highlightDates = []) {
            if (fpInstance) fpInstance.destroy();

            fpInstance = flatpickr("#masterCalendar", {
                defaultDate: selectedDate, 
                dateFormat: "Y-m-d",
                onDayCreate: (dObj, dStr, fp, dayElem) => {
                    const dateStr = fp.formatDate(dayElem.dateObj, "Y-m-d");
                    if (highlightDates.includes(dateStr)) dayElem.classList.add("has-brew-date");
                },
                onChange: (selectedDates, dateStr) => {
                    selectedDate = dateStr;
                    document.getElementById('targetDateDisplay').innerText = `Se√ßili G√ºn: ${dateStr}`;
                    renderLogs();
                }
            });
        }

        supa.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            if (currentUser) {
                document.getElementById('loginBtnTrigger').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('userEmail').innerText = currentUser.email;
                document.getElementById('userEmail').style.display = 'block';
                document.getElementById('authModal').classList.remove('active');
                fetchLogs();
            } else {
                document.getElementById('logsContainer').innerHTML = '<p style="color:var(--text-light); text-align:center; margin-top:2rem; font-size:0.85rem;">‚ö†Ô∏è G√ºnl√ºk kullanƒ±mƒ± i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.</p>';
            }
        });

        async function fetchLogs() {
            if (!currentUser) return;
            const { data } = await supa.from('brew_logs').select(`*, beans(*), grinders(*)`).order('brew_date', { ascending: false });
            if (data) {
                brewLogs = data;
                initCalendar([...new Set(data.map(l => l.brew_date))]);
                renderLogs();
            }
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            if (!currentUser) return;
            container.innerHTML = '';
            
            const filtered = brewLogs.filter(l => l.brew_date === selectedDate && (activeTypeFilter === 'all' || l.beans?.type === activeTypeFilter));

            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:gray; font-size:0.8rem; margin-top:2rem;">${selectedDate} tarihinde '${activeTypeFilter.toUpperCase()}' kaydƒ± yok.</p>`;
                return;
            }

            filtered.forEach(log => {
                const div = document.createElement('div');
                div.className = 'log-item';
                
                const brewerInfo = log.brewer ? log.brewer : '';
                const filterInfo = log.filter_paper ? ` (${log.filter_paper})` : '';
                const equipStr = (brewerInfo || filterInfo) ? `<div style="color:var(--primary); font-size:0.75rem; font-weight:600; margin:3px 0;">‚òï ${brewerInfo}${filterInfo}</div>` : '';

                const waterDetails = [];
                if(log.water) waterDetails.push(log.water);
                if(log.water_ca) waterDetails.push(`Ca:${log.water_ca}`);
                if(log.water_na) waterDetails.push(`Na:${log.water_na}`);
                if(log.water_k) waterDetails.push(`K:${log.water_k}`);
                const waterStr = waterDetails.length > 0 ? ` | Su: ${waterDetails.join(', ')}` : '';

                const moodTag = log.mood ? `<span class="vibe-tag">üé≠ ${log.mood}</span>` : '';
                const musicTag = log.music ? `<span class="vibe-tag">üéµ ${log.music}</span>` : '';
                const vibeSection = (moodTag || musicTag) ? `<div style="margin-top: 8px;">${moodTag}${musicTag}</div>` : '';

                div.innerHTML = `
                    <strong>${log.beans?.roaster} - ${log.beans?.name}</strong>
                    ${equipStr}
                    <div style="font-size:0.8rem;">${log.temperature}¬∞C | ${log.clicks} Klik ${waterStr}</div>
                    <em style="font-size:0.75rem; color:var(--text-light); display:block; margin-top:6px;">"${log.notes || ''}"</em>
                    ${vibeSection}
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const status = document.getElementById('statusMsg');
            const beanId = document.getElementById('finalBeanSelect').value;

            if (!currentUser) { status.style.color = "#d9534f"; status.innerText = "‚ö†Ô∏è L√ºtfen √∂nce giri≈ü yapƒ±n!"; return; }
            if (!beanId) { status.style.color = "#d9534f"; status.innerText = "‚ö†Ô∏è L√ºtfen bir √ßekirdek se√ßin!"; return; }

            status.style.color = "var(--text-main)";
            status.innerText = "Kaydediliyor...";

            const { error } = await supa.from('brew_logs').insert([{
                user_id: currentUser.id,
                bean_id: beanId,
                brew_date: selectedDate,
                brewer: document.getElementById('brewerSelect').value || null,
                filter_paper: document.getElementById('filterSelect').value || null,
                grinder_id: document.getElementById('grinderSelect').value || null,
                temperature: document.getElementById('tempInput').value || null,
                clicks: document.getElementById('clickInput').value || null,
                water: document.getElementById('waterInput').value || null,
                water_ca: document.getElementById('waterCa').value || null,
                water_na: document.getElementById('waterNa').value || null,
                water_k: document.getElementById('waterK').value || null,
                mood: document.getElementById('moodInput').value || null,
                music: document.getElementById('musicInput').value || null,
                notes: document.getElementById('notesInput').value || null
            }]);

            if (error) {
                status.style.color = "#d9534f"; 
                status.innerText = "Hata: " + error.message; 
            } else {
                status.style.color = "var(--primary)"; 
                status.innerText = "‚úÖ Ba≈üarƒ±yla kaydedildi!"; 
                
                ['tempInput', 'clickInput', 'waterInput', 'waterCa', 'waterNa', 'waterK', 'notesInput', 'brewerSelect', 'filterSelect', 'moodInput', 'musicInput'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                
                fetchLogs(); 
                setTimeout(() => status.innerText = "", 3000); 
            }
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeTypeFilter = btn.dataset.type;
                renderLogs();
            });
        });

        document.getElementById('beanSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const res = document.getElementById('searchResults');
            res.innerHTML = '';
            if (term.length < 2) { res.style.display = 'none'; return; }
            const matches = currentBeans.filter(b => b.name.toLowerCase().includes(term) || b.roaster.toLowerCase().includes(term));
            if (matches.length > 0) {
                res.style.display = 'block';
                matches.forEach(b => {
                    const d = document.createElement('div'); d.className = 'search-item'; d.innerHTML = `<strong>${b.roaster}</strong> - ${b.name}`;
                    d.onclick = () => {
                        document.getElementById('beanSearch').value = `${b.roaster} - ${b.name}`;
                        document.getElementById('finalBeanSelect').value = b.id;
                        res.style.display = 'none';
                        const rc = document.getElementById('refCard');
                        rc.classList.add('active');
                        document.getElementById('refTemp').innerText = b.ref_temp || '-';
                        document.getElementById('refGrind').innerText = b.ref_grind || '-';
                        document.getElementById('refRatio').innerText = b.ref_ratio || '-';
                        document.getElementById('refNote').innerText = b.ref_note || '√ñrn: Yasemin, bergamot...';
                    };
                    res.appendChild(d);
                });
            }
        });

        async function fetchBeans() {
            const { data } = await supa.from('beans').select('*');
            if (data) { currentBeans = data; data.forEach(b => document.getElementById('finalBeanSelect').add(new Option(b.name, b.id))); }
        }

        async function fetchGrinders() {
            const { data } = await supa.from('grinders').select('*');
            const sel = document.getElementById('grinderSelect');
            if (data) { sel.innerHTML = '<option value="">Deƒüirmen Se√ßin...</option>'; data.forEach(g => sel.add(new Option(`${g.brand} ${g.model}`, g.id))); }
        }

        document.getElementById('loginBtnTrigger').addEventListener('click', () => {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('magicLinkForm').style.display = 'block';
            document.getElementById('magicLinkSuccess').style.display = 'none';
            document.getElementById('authErrorMsg').innerText = '';
        });

        document.getElementById('authModal').addEventListener('click', function(e) {
            if (e.target.id === 'authModal') {
                this.classList.remove('active');
            }
        });

        document.getElementById('magicLinkBtn').addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const turnstile = document.querySelector('[name="cf-turnstile-response"]')?.value;
            const errorMsg = document.getElementById('authErrorMsg');
            
            if(!email || !turnstile) {
                errorMsg.innerText = "L√ºtfen e-postanƒ±zƒ± girin ve doƒürulamayƒ± yapƒ±n.";
                return;
            }

            const { error } = await supa.auth.signInWithOtp({ email, options: { captchaToken: turnstile } });
            
            if(!error) { 
                document.getElementById('magicLinkForm').style.display = 'none'; 
                document.getElementById('magicLinkSuccess').style.display = 'block'; 
                errorMsg.innerText = '';
            } else {
                errorMsg.innerText = error.message;
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => supa.auth.signOut());

        initCalendar(); fetchBeans(); fetchGrinders();
    </script>
</body>
</html>