<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postroast | Beanology</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root { --bg-color: #F4F4F6; --card-bg: #FFFFFF; --primary: #8B9A8B; --border-color: #E2E4E9; --text-main: #2C303A; --text-light: #8E94A3; --reference-bg: #F9FAFB; --modal-bg: rgba(44,48,58,0.5); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); padding: 2rem; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .auth-bar { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .logo { font-size: 1.5rem; font-weight: 600; }

        .container { max-width: 1000px; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 950px; }
        
        /* Arama ve Form */
        .form-group { margin-bottom: 1.2rem; position: relative; }
        label { display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.4rem; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; background: #FAFAFB; }
        
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); z-index: 100; display: none; max-height: 200px; overflow-y: auto; border-radius: 0 0 6px 6px; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .search-item:hover { background: #f0f4f0; }

        /* Yeşil Takvim Stili */
        .has-brew { background: #8B9A8B !important; color: white !important; border-radius: 50%; }

        /* Geçmiş & Kaydırma */
        #logsContainer { overflow-y: auto; flex-grow: 1; margin-top: 1rem; padding-right: 5px; }
        #logsContainer::-webkit-scrollbar { width: 4px; }
        #logsContainer::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .log-date-header { font-size: 0.7rem; font-weight: 800; color: var(--text-light); margin-top: 1.5rem; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .log-item { background: white; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-top: 0.5rem; }

        .btn-primary { width: 100%; padding: 0.9rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
        
        .ref-card { background: var(--reference-bg); border-radius: 8px; padding: 1.2rem; display: none; margin-bottom: 1rem; border: 1px solid var(--border-color); }
        .ref-card.active { display: block; }

        .modal { position: fixed; inset: 0; background: var(--modal-bg); display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 350px; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="auth-bar">
        <div class="logo">Postroast</div>
        <div id="userInfo">
            <span id="userEmail" style="display:none; font-size: 0.8rem; margin-right: 10px;"></span>
            <button class="btn-outline" id="loginBtnTrigger">Giriş Yap</button>
            <button class="btn-outline" id="logoutBtn" style="display:none;">Çıkış Yap</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Beanology Veri Girişi</h2>
            
            <div class="form-group">
                <label>Demleme Tarihi</label>
                <input type="text" id="entryDate" placeholder="Tarih seçin...">
            </div>

            <div class="form-group">
                <label>Çekirdek Ara & Seç</label>
                <input type="text" id="beanSearch" placeholder="Kavurucu veya çekirdek adı..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
                <select id="finalBeanSelect" style="display:none;"></select>
            </div>

            <div class="ref-card" id="refCard">
                <p style="font-size: 0.7rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">REFERANS</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                    <div><span id="refTemp" style="font-weight: 600;">-</span><br><small>Isı</small></div>
                    <div><span id="refGrind" style="font-weight: 600;">-</span><br><small>Klik</small></div>
                    <div><span id="refRatio" style="font-weight: 600;">-</span><br><small>Oran</small></div>
                </div>
                <p id="refNote" style="font-size: 0.8rem; font-style: italic; margin-top: 10px; color: var(--text-light);"></p>
            </div>

            <div class="form-group">
                <label>Değirmen</label>
                <select id="grinderSelect"><option value="">Değirmenler yükleniyor...</option></select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label>Isı (°C)</label><input type="number" id="tempInput"></div>
                <div class="form-group"><label>Klik</label><input type="number" id="clickInput"></div>
            </div>

            <div class="form-group"><label>Tadım Notları</label><textarea id="notesInput" rows="2"></textarea></div>
            
            <button class="btn-primary" id="saveBtn">Günlüğe Kaydet</button>
            <p id="statusMsg" style="text-align: center; font-size: 0.8rem; margin-top: 10px;"></p>
        </div>

        <div class="card">
            <h2>Geçmiş Demlemelerim</h2>
            
            <div class="form-group">
                <label>Tarihe Git (Yeşiller demleme olan günler)</label>
                <input type="text" id="calendarView" placeholder="Takvimi aç...">
            </div>

            <div id="logsContainer">
                <p style="text-align: center; color: var(--text-light); margin-top: 2rem;">Giriş yapın.</p>
            </div>
        </div>
    </div>

    <div class="modal" id="authModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem; text-align: center;">Postroast Giriş</h3>
            <input type="email" id="authEmail" placeholder="kahve@mail.com" style="margin-bottom: 1rem;">
            <div class="cf-turnstile" data-sitekey="0x4AAAAAACfmb3Fmt8T7v11x" style="margin-bottom: 1rem; display: flex; justify-content: center;"></div>
            <button class="btn-primary" id="magicLinkBtn">Bağlantı Gönder</button>
            <div id="magicSuccess" style="display:none; color: green; font-size: 0.8rem; margin-top: 10px; text-align: center;">E-postanı kontrol et!</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fczapxjfbpddkburssez.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjemFweGpmYnBkZGtidXJzc2V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDQ4MTYsImV4cCI6MjA4NzA4MDgxNn0.7eyw43dNE7DRnOvRIQFanQXvUCX7bPpYh5qlrAUMMk0';
        const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentBeans = [], brewLogs = [], currentUser = null;
        let entryPicker, viewPicker;

        // --- TAKVİMLERİ BAŞLAT (Flatpickr) ---
        function setupCalendars(highlightDates = []) {
            // Sol taraf: Veri girişi için
            entryPicker = flatpickr("#entryDate", { defaultDate: "today", dateFormat: "Y-m-d", locale: "tr" });

            // Sağ taraf: Görüntüleme ve Yeşil günler için
            viewPicker = flatpickr("#calendarView", {
                inline: false,
                dateFormat: "Y-m-d",
                onDayCreate: (dObj, dStr, fp, dayElem) => {
                    const dateStr = dayElem.dateObj.toISOString().split('T')[0];
                    if (highlightDates.includes(dateStr)) {
                        dayElem.classList.add("has-brew");
                    }
                },
                onChange: (selectedDates, dateStr) => { renderLogs(dateStr); }
            });
        }

        // --- AUTH & INITIALIZE ---
        async function init() {
            setupCalendars();
            fetchBeans();
            fetchGrinders();
        }

        supa.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            if (currentUser) {
                document.getElementById('loginBtnTrigger').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('userEmail').innerText = currentUser.email;
                document.getElementById('userEmail').style.display = 'inline';
                fetchLogs();
            }
        });

        // --- VERİ İŞLEMLERİ ---
        async function fetchLogs() {
            if (!currentUser) return;
            const { data } = await supa.from('brew_logs').select(`*, beans(name, roaster, type), grinders(brand, model)`).order('brew_date', { ascending: false });
            if (data) {
                brewLogs = data;
                const dates = [...new Set(data.map(l => l.brew_date))];
                setupCalendars(dates); // Takvimi yeşil günlerle güncelle
                renderLogs();
            }
        }

        function renderLogs(filterDate = null) {
            const container = document.getElementById('logsContainer');
            container.innerHTML = '';
            
            const filtered = brewLogs.filter(l => !filterDate || l.brew_date === filterDate);
            if (filtered.length === 0) { container.innerHTML = '<p style="font-size: 0.8rem; color: gray; text-align: center;">Kayıt yok.</p>'; return; }

            let lastDate = "";
            filtered.forEach(log => {
                if (log.brew_date !== lastDate) {
                    const h = document.createElement('div'); h.className = 'log-date-header'; h.innerText = log.brew_date;
                    container.appendChild(h); lastDate = log.brew_date;
                }
                const item = document.createElement('div');
                item.className = 'log-item';
                item.innerHTML = `<strong>${log.beans?.roaster} - ${log.beans?.name}</strong><br><small>${log.temperature}°C | ${log.clicks} Klik</small>`;
                container.appendChild(item);
            });
        }

        // --- KAYDETME (DÜZELTİLDİ) ---
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const beanId = document.getElementById('finalBeanSelect').value;
            const selectedDate = document.getElementById('entryDate').value; // TAKVİMDEN GELEN TARİH

            if (!currentUser || !beanId) return alert("Lütfen giriş yapın ve çekirdeğe TIKLAYARAK seçin.");

            const { error } = await supa.from('brew_logs').insert([{
                user_id: currentUser.id,
                bean_id: beanId,
                brew_date: selectedDate, // DB'ye gönderilen tarih
                temperature: document.getElementById('tempInput').value,
                clicks: document.getElementById('clickInput').value,
                notes: document.getElementById('notesInput').value,
                grinder_id: document.getElementById('grinderSelect').value || null
            }]);

            if (!error) {
                document.getElementById('statusMsg').innerText = "Kaydedildi! Takvim güncelleniyor...";
                fetchLogs(); // Listeyi ve yeşil günleri tazele
                setTimeout(() => document.getElementById('statusMsg').innerText = "", 2000);
            }
        });

        // (fetchBeans, fetchGrinders, Arama ve Auth kodları öncekiyle aynı şekilde devam eder...)
        async function fetchBeans() {
            const { data } = await supa.from('beans').select('*');
            if (data) { currentBeans = data; data.forEach(b => document.getElementById('finalBeanSelect').add(new Option(b.name, b.id))); }
        }

        async function fetchGrinders() {
            const { data } = await supa.from('grinders').select('*');
            const sel = document.getElementById('grinderSelect');
            if (data) { sel.innerHTML = '<option value="">Değirmen...</option>'; data.forEach(g => sel.add(new Option(`${g.brand} ${g.model}`, g.id))); }
        }

        document.getElementById('beanSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const res = document.getElementById('searchResults');
            res.innerHTML = '';
            if (term.length < 2) { res.style.display = 'none'; return; }
            const matches = currentBeans.filter(b => b.name.toLowerCase().includes(term) || b.roaster.toLowerCase().includes(term));
            if (matches.length > 0) {
                res.style.display = 'block';
                matches.forEach(b => {
                    const d = document.createElement('div'); d.className = 'search-item'; d.innerHTML = `<strong>${b.roaster}</strong> - ${b.name}`;
                    d.onclick = () => {
                        document.getElementById('beanSearch').value = `${b.roaster} - ${b.name}`;
                        document.getElementById('finalBeanSelect').value = b.id;
                        res.style.display = 'none';
                        document.getElementById('refCard').classList.add('active');
                        document.getElementById('refTemp').innerText = b.ref_temp;
                        document.getElementById('refGrind').innerText = b.ref_grind;
                        document.getElementById('refRatio').innerText = b.ref_ratio;
                        document.getElementById('refNote').innerText = b.ref_note;
                    };
                    res.appendChild(d);
                });
            }
        });

        document.getElementById('loginBtnTrigger').addEventListener('click', () => document.getElementById('authModal').classList.add('active'));
        document.getElementById('logoutBtn').addEventListener('click', () => supa.auth.signOut());
        document.getElementById('magicLinkBtn').addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const token = document.querySelector('[name="cf-turnstile-response"]')?.value;
            await supa.auth.signInWithOtp({ email, options: { captchaToken: token } });
            document.getElementById('magicSuccess').style.display = 'block';
        });

        init();
    </script>
</body>
</html>