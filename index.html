<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postroast | Beanology</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root { --bg-color: #F4F4F6; --card-bg: #FFFFFF; --primary: #8B9A8B; --primary-hover: #7A897A; --border-color: #E2E4E9; --text-main: #2C303A; --text-light: #8E94A3; --reference-bg: #F9FAFB; --modal-bg: rgba(44,48,58,0.5); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); padding: 2rem; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .auth-bar { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.5px; }
        .user-info { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; color: var(--text-main); transition: 0.2s;}
        .btn-outline:hover { background: var(--bg-color); }

        .container { max-width: 1000px; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color); display: flex; flex-direction: column;}
        h2 { font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.4rem; font-weight: 500;}
        input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: #FAFAFB; transition: 0.2s; color: var(--text-main);}
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background-color: #fff;}
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        button.btn-primary { width: 100%; padding: 0.9rem; background-color: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s;}
        button.btn-primary:hover { background-color: var(--primary-hover); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .ref-card { background-color: var(--reference-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; display: none; margin-bottom: 1.5rem;}
        .ref-card.active { display: block; }
        .ref-badge { display: inline-block; background-color: var(--primary); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-bottom: 1rem; }
        .ref-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .ref-stat-val { font-size: 1.1rem; font-weight: 600; display: block; color: var(--text-main);}
        .ref-stat-label { font-size: 0.75rem; color: var(--text-light); }
        .ref-note { font-size: 0.85rem; font-style: italic; color: var(--text-light); border-left: 3px solid var(--primary); padding-left: 1rem; }
        
        /* Yeni: Aroma Etiketleri */
        .tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }
        .flavor-tag { background: #FAFAFB; border: 1px solid var(--border-color); color: var(--text-light); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; user-select: none; }
        .flavor-tag:hover { border-color: var(--primary); color: var(--text-main); }
        .flavor-tag.active { background: var(--primary); color: white; border-color: var(--primary); }

        .time-inputs { display: flex; align-items: center; gap: 0.5rem; }
        .time-inputs input { text-align: center; padding: 0.75rem 0.5rem; }

        .log-item { background: #FFFFFF; border: 1px solid var(--border-color); padding: 1.2rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
        .log-meta { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.8rem; }
        .badge { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-main); }
        .badge-tags { background: #F0F4F0; color: #4A5D23; border: none; font-weight: 500; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 12px;}

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; backdrop-filter: blur(3px); transition: 0.3s; z-index: 1000;}
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); padding: 2.5rem; border-radius: 12px; width: 100%; max-width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.3s;}
        .modal.active .modal-content { transform: translateY(0); }
        .modal-header { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; text-align: center; border: none; padding: 0;}
        .success-box { display: none; background-color: #e8f5e9; color: #2e7d32; padding: 1rem; border-radius: 6px; text-align: center; font-size: 0.9rem; margin-top: 1rem; border: 1px solid #c8e6c9; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="auth-bar">
        <div class="logo">Postroast</div>
        <div class="user-info" id="userInfo">
            <span id="userEmail" style="display: none; color: var(--text-light);"></span>
            <button class="btn-outline" id="loginBtnTrigger">Giri≈ü Yap</button>
            <button class="btn-outline" id="logoutBtn" style="display: none;">√áƒ±kƒ±≈ü Yap</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Beanology Veri Giri≈üi</h2>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>Y√∂ntem</label>
                    <select id="methodSelect">
                        <option value="Filtre">üíß Filtre</option>
                        <option value="Espresso">‚òï Espresso</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>√áekirdek</label>
                    <select id="beanSelect"><option value="">Y√ºkleniyor...</option></select>
                </div>
            </div>
            
            <div class="ref-card" id="refCard">
                <span class="ref-badge">Postroast Referans</span>
                <div class="ref-stats">
                    <div><span class="ref-stat-val" id="refTemp">-</span><span class="ref-stat-label">Sƒ±caklƒ±k</span></div>
                    <div><span class="ref-stat-val" id="refGrind">-</span><span class="ref-stat-label">√ñƒü√ºtme</span></div>
                    <div><span class="ref-stat-val" id="refRatio">-</span><span class="ref-stat-label">Oran</span></div>
                </div>
                <p class="ref-note" id="refNote">-</p>
            </div>

            <div class="form-group">
                <label>Kullanƒ±lan Deƒüirmen</label>
                <select id="grinderSelect"><option value="">Y√ºkleniyor...</option></select>
            </div>
            
            <div class="grid-3">
                <div class="form-group"><label>Sƒ±caklƒ±k (¬∞C)</label><input type="number" id="tempInput" placeholder="92"></div>
                <div class="form-group"><label>Ayar / Klik</label><input type="number" id="clickInput" placeholder="23"></div>
                <div class="form-group"><label>Agtron</label><input type="number" id="agtronInput" placeholder="√ñrn: 65"></div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>Kullanƒ±lan Su</label>
                    <input type="text" id="waterInput" placeholder="Buzdaƒüƒ±, Arƒ±tma...">
                </div>
                <div class="form-group">
                    <label>Demleme S√ºresi</label>
                    <div class="time-inputs">
                        <input type="number" id="timeMin" placeholder="Dk" min="0" max="15">
                        <span style="color: var(--text-light);">:</span>
                        <input type="number" id="timeSec" placeholder="Sn" min="0" max="59">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Aroma Profili (G√∂rsel √áark)</label>
                <div class="tags-container" id="flavorTags">
                    <div class="flavor-tag" data-val="√áilek">√áilek</div>
                    <div class="flavor-tag" data-val="Karamel">Karamel</div>
                    <div class="flavor-tag" data-val="√áikolata">√áikolata</div>
                    <div class="flavor-tag" data-val="Yasemin">Yasemin</div>
                    <div class="flavor-tag" data-val="Narenciye">Narenciye</div>
                    <div class="flavor-tag" data-val="Fƒ±ndƒ±k">Fƒ±ndƒ±k</div>
                    <div class="flavor-tag" data-val="Bergamot">Bergamot</div>
                    <div class="flavor-tag" data-val="≈ûeftali">≈ûeftali</div>
                </div>
            </div>

            <div class="form-group"><label>Ekstra Tadƒ±m Notlarƒ±</label><textarea id="notesInput" rows="2" placeholder="G√∂vde, biti≈ü ve diƒüer hissiyatlar..."></textarea></div>
            <button class="btn-primary" id="saveBtn">G√ºnl√ºƒüe Kaydet</button>
            <p id="statusMsg" style="margin-top: 1rem; font-size: 0.85rem; text-align: center;"></p>
        </div>

        <div class="card">
            <h2>Ge√ßmi≈ü Demlemelerim</h2>
            <div id="logsContainer">
                <p style="color: var(--text-light); font-size: 0.9rem;">Verileri g√∂rmek i√ßin giri≈ü yapƒ±n.</p>
            </div>
        </div>
    </div>

    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2 class="modal-header">Postroast'a Katƒ±l</h2>
            <p style="text-align: center; color: var(--text-light); font-size: 0.9rem; margin-bottom: 1.5rem;">≈ûifre yok. E-postanƒ± gir, sana tek kullanƒ±mlƒ±k bir giri≈ü baƒülantƒ±sƒ± g√∂nderelim.</p>
            <div class="form-group" id="magicLinkForm">
                <input type="email" id="authEmail" placeholder="kahve.tutkunu@mail.com" style="margin-bottom: 1rem; text-align: center;">
                <div class="cf-turnstile" data-sitekey="0x4AAAAAACfmb3Fmt8T7v11x" style="margin-bottom: 1rem; display: flex; justify-content: center;"></div>
                <button class="btn-primary" id="magicLinkBtn">Sihirli Baƒülantƒ± G√∂nder</button>
            </div>
            <div class="success-box" id="magicLinkSuccess">Giri≈ü baƒülantƒ±sƒ± e-posta adresinize g√∂nderildi. L√ºtfen gelen kutunuzu kontrol edin.</div>
            <p id="authErrorMsg" style="color: #d9534f; font-size: 0.8rem; margin-top: 1rem; text-align: center;"></p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fczapxjfbpddkburssez.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjemFweGpmYnBkZGtidXJzc2V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDQ4MTYsImV4cCI6MjA4NzA4MDgxNn0.7eyw43dNE7DRnOvRIQFanQXvUCX7bPpYh5qlrAUMMk0';
        const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentBeans = [];
        let currentUser = null;
        let selectedFlavors = []; // Aroma etiketlerini tutan dizi

        // Aroma Etiketleri Mantƒ±ƒüƒ±
        document.querySelectorAll('.flavor-tag').forEach(tag => {
            tag.addEventListener('click', (e) => {
                const val = e.target.getAttribute('data-val');
                if(selectedFlavors.includes(val)) {
                    selectedFlavors = selectedFlavors.filter(t => t !== val);
                    e.target.classList.remove('active');
                } else {
                    selectedFlavors.push(val);
                    e.target.classList.add('active');
                }
            });
        });

        const authModal = document.getElementById('authModal');
        
        supa.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            updateAuthUI();
            if (currentUser) {
                authModal.classList.remove('active');
                fetchLogs(); 
            } else {
                document.getElementById('logsContainer').innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">Verileri g√∂rmek i√ßin giri≈ü yapƒ±n.</p>';
            }
        });

        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('loginBtnTrigger').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('userEmail').style.display = 'block';
                document.getElementById('userEmail').innerText = currentUser.email;
            } else {
                document.getElementById('loginBtnTrigger').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('userEmail').style.display = 'none';
            }
        }

        document.getElementById('loginBtnTrigger').addEventListener('click', () => {
            authModal.classList.add('active');
            document.getElementById('magicLinkSuccess').style.display = 'none';
            document.getElementById('magicLinkForm').style.display = 'block';
            document.getElementById('authErrorMsg').innerText = '';
        });
        
        authModal.addEventListener('click', (e) => { if (e.target === authModal) authModal.classList.remove('active'); });

        document.getElementById('magicLinkBtn').addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const errorMsg = document.getElementById('authErrorMsg');
            errorMsg.innerText = '';
            
            if(!email) return errorMsg.innerText = 'L√ºtfen e-posta adresinizi girin.';

            const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
            const captchaToken = turnstileResponse ? turnstileResponse.value : '';

            if (!captchaToken) return errorMsg.innerText = 'L√ºtfen g√ºvenlik doƒürulamasƒ±nƒ± (CAPTCHA) tamamlayƒ±n.';

            const btn = document.getElementById('magicLinkBtn');
            btn.innerText = 'G√∂nderiliyor...'; btn.disabled = true;

            const { error } = await supa.auth.signInWithOtp({
                email: email,
                options: { captchaToken: captchaToken, emailRedirectTo: window.location.origin }
            });

            btn.innerText = 'Sihirli Baƒülantƒ± G√∂nder'; btn.disabled = false;

            if (error) {
                errorMsg.innerText = "Hata: " + error.message;
                if(typeof turnstile !== 'undefined') turnstile.reset();
            } else {
                document.getElementById('magicLinkForm').style.display = 'none';
                document.getElementById('magicLinkSuccess').style.display = 'block';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supa.auth.signOut();
            document.getElementById('logsContainer').innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">Verileri g√∂rmek i√ßin giri≈ü yapƒ±n.</p>';
        });

        async function fetchBeans() {
            const { data } = await supa.from('beans').select('*');
            const select = document.getElementById('beanSelect');
            if (data) {
                currentBeans = data;
                select.innerHTML = '<option value="" disabled selected>√áekirdek Se√ßin...</option>';
                data.forEach(bean => select.add(new Option(`${bean.roaster} - ${bean.name}`, bean.id)));
            }
        }

        async function fetchGrinders() {
            const { data } = await supa.from('grinders').select('*');
            const select = document.getElementById('grinderSelect');
            if (data) {
                select.innerHTML = '<option value="" disabled selected>Deƒüirmen Se√ßin...</option>';
                data.forEach(g => select.add(new Option(`${g.brand} ${g.model}`, g.id)));
            }
        }

        document.getElementById('beanSelect').addEventListener('change', (e) => {
            const bean = currentBeans.find(b => b.id === e.target.value);
            const refCard = document.getElementById('refCard');
            if (bean && bean.ref_temp) {
                document.getElementById('refTemp').innerText = bean.ref_temp;
                document.getElementById('refGrind').innerText = bean.ref_grind;
                document.getElementById('refRatio').innerText = bean.ref_ratio;
                document.getElementById('refNote').innerText = bean.ref_note;
                refCard.classList.add('active');
            } else { refCard.classList.remove('active'); }
        });

        async function fetchLogs() {
            if (!currentUser) return; 
            const { data, error } = await supa.from('brew_logs').select(`id, method, temperature, clicks, water, agtron, brew_time, flavor_tags, notes, beans (roaster, name), grinders (brand, model)`).order('created_at', { ascending: false });
            
            const container = document.getElementById('logsContainer');
            if (data && data.length > 0) {
                container.innerHTML = '';
                data.forEach(log => {
                    const bName = log.beans ? `${log.beans.roaster} - ${log.beans.name}` : 'Bilinmeyen';
                    const gName = log.grinders ? `${log.grinders.brand} ${log.grinders.model}` : '-';
                    const methodBadge = log.method === 'Espresso' ? '‚òï Espresso' : 'üíß Filtre';
                    
                    let metaInfo = `<span class="badge">${methodBadge}</span> <span class="badge">‚öôÔ∏è ${gName}</span>`;
                    if (log.water) metaInfo += ` <span class="badge">üíß ${log.water}</span>`;
                    if (log.agtron) metaInfo += ` <span class="badge">Agtron: ${log.agtron}</span>`;
                    if (log.brew_time) metaInfo += ` <span class="badge">‚è±Ô∏è ${log.brew_time}</span>`;

                    let tagsHtml = '';
                    if (log.flavor_tags && log.flavor_tags.length > 0) {
                        tagsHtml = `<div style="margin-top:0.5rem; display:flex; gap:0.3rem; flex-wrap:wrap;">`;
                        log.flavor_tags.forEach(tag => tagsHtml += `<span class="badge-tags">${tag}</span>`);
                        tagsHtml += `</div>`;
                    }
                    
                    container.innerHTML += `
                        <div class="log-item">
                            <strong style="color: var(--text-main); font-size:1.05rem;">${bName}</strong>
                            <div class="log-meta" style="margin-top:0.5rem;">${metaInfo}</div>
                            Isƒ±: ${log.temperature || '-'}¬∞C | Klik: ${log.clicks || '-'}<br>
                            ${tagsHtml}
                            <em style="color: var(--text-light); margin-top:0.5rem; display:block;">"${log.notes || '-'}"</em>
                        </div>`;
                });
            } else {
                container.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">Hen√ºz kayƒ±t yok.</p>';
            }
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            if (!currentUser) return alert("L√ºtfen √∂nce giri≈ü yapƒ±n!");
            
            const beanId = document.getElementById('beanSelect').value;
            if (!beanId) return alert("√áekirdek se√ßimi zorunludur.");

            const statusMsg = document.getElementById('statusMsg');
            statusMsg.style.color = "var(--text-main)";
            statusMsg.innerText = "Kaydediliyor...";

            // S√ºreyi birle≈ütir (√ñrn: "02:30")
            const min = document.getElementById('timeMin').value;
            const sec = document.getElementById('timeSec').value;
            let brewTimeStr = null;
            if(min || sec) {
                brewTimeStr = `${min ? min.padStart(2, '0') : '00'}:${sec ? sec.padStart(2, '0') : '00'}`;
            }

            const { error } = await supa.from('brew_logs').insert([{
                user_id: currentUser.id,
                method: document.getElementById('methodSelect').value,
                bean_id: beanId,
                grinder_id: document.getElementById('grinderSelect').value || null,
                temperature: document.getElementById('tempInput').value || null,
                clicks: document.getElementById('clickInput').value || null,
                water: document.getElementById('waterInput').value || null,
                agtron: document.getElementById('agtronInput').value || null,
                brew_time: brewTimeStr,
                flavor_tags: selectedFlavors.length > 0 ? selectedFlavors : null,
                notes: document.getElementById('notesInput').value || null
            }]);

            if (error) {
                statusMsg.style.color = "#d9534f";
                statusMsg.innerText = "Hata: " + error.message;
            } else {
                statusMsg.style.color = "var(--primary)";
                statusMsg.innerText = "Ba≈üarƒ±yla kaydedildi!";
                
                // Formu Temizle
                document.querySelectorAll('input[type="number"], input[type="text"], textarea').forEach(el => el.value = '');
                document.querySelectorAll('.flavor-tag').forEach(tag => tag.classList.remove('active'));
                selectedFlavors = []; // Diziyi sƒ±fƒ±rla
                
                fetchLogs();
                setTimeout(() => statusMsg.innerText = '', 3000);
            }
        });

        fetchBeans();
        fetchGrinders();

    </script>
</body>
</html>